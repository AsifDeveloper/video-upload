// tslint:disable: no-bitwise
function safeMatch(base, re) {
    return (base.match(re) || [])[0] || '';
}
export function resolveUrl(url, base) {
    if (url.indexOf('https://') * url.indexOf('http://') === 0) {
        return url;
    }
    if (url.indexOf('//') === 0) {
        return safeMatch(base, /^(https?:)/) + url;
    }
    if (url.indexOf('/') === 0) {
        return safeMatch(base, /^(?:https?:)?(?:\/\/)?([^\/\?]+)/) + url;
    }
    return safeMatch(base, /^(?:https?:)?(?:\/\/)?([^\/\?]+)?(.*\/)/) + url;
}
export function unfunc(value, ref) {
    return value instanceof Function ? value(ref) : value;
}
export const noop = () => { };
export const pick = (obj, whitelist) => {
    const result = {};
    whitelist.forEach(key => (result[key] = obj[key]));
    return result;
};
export function isNumber(x) {
    return x === Number(x);
}
export function isString(x) {
    return typeof x === 'string';
}
/**
 * 32-bit FNV-1a hash function
 */
export function createHash(str) {
    let hash = 2166136261;
    const len = str.length;
    for (let i = 0; i < len; i++) {
        hash ^= str.charCodeAt(i);
        hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
    }
    return hash >>> 0;
}
export const b64 = {
    encode: (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode(Number.parseInt(p1, 16)))),
    decode: (str) => decodeURIComponent(atob(str)
        .split('')
        .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
        .join('')),
    serialize: (obj) => {
        return Object.entries(obj)
            .map(([key, value]) => `${key} ${b64.encode(String(value))}`)
            .toString();
    },
    parse: (encoded) => {
        const kvPairs = encoded.split(',').map(kv => kv.split(' '));
        const decoded = Object.create(null);
        for (const [key, value] of kvPairs) {
            decoded[key] = b64.decode(value);
        }
        return decoded;
    }
};
/**
 * Adaptive chunk size
 */
export class DynamicChunk {
    static scale(throughput) {
        const elapsedTime = DynamicChunk.size / throughput;
        if (elapsedTime < DynamicChunk.minChunkTime) {
            DynamicChunk.size = Math.min(DynamicChunk.maxSize, DynamicChunk.size * 2);
        }
        if (elapsedTime > DynamicChunk.maxChunkTime) {
            DynamicChunk.size = Math.max(DynamicChunk.minSize, DynamicChunk.size / 2);
        }
        return DynamicChunk.size;
    }
}
/** Maximum chunk size in bytes */
DynamicChunk.maxSize = Number.MAX_SAFE_INTEGER;
/** Minimum chunk size in bytes */
DynamicChunk.minSize = 1024 * 256;
/** Initial chunk size in bytes */
DynamicChunk.size = 4096 * 256;
DynamicChunk.minChunkTime = 2;
DynamicChunk.maxChunkTime = 8;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdXBsb2FkeC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw2QkFBNkI7QUFFN0IsU0FBUyxTQUFTLENBQUMsSUFBWSxFQUFFLEVBQVU7SUFDekMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3pDLENBQUM7QUFDRCxNQUFNLFVBQVUsVUFBVSxDQUFDLEdBQVcsRUFBRSxJQUFZO0lBQ2xELElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUMxRCxPQUFPLEdBQUcsQ0FBQztLQUNaO0lBQ0QsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUMzQixPQUFPLFNBQVMsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLEdBQUcsR0FBRyxDQUFDO0tBQzVDO0lBQ0QsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUMxQixPQUFPLFNBQVMsQ0FBQyxJQUFJLEVBQUUsa0NBQWtDLENBQUMsR0FBRyxHQUFHLENBQUM7S0FDbEU7SUFDRCxPQUFPLFNBQVMsQ0FBQyxJQUFJLEVBQUUseUNBQXlDLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDMUUsQ0FBQztBQUVELE1BQU0sVUFBVSxNQUFNLENBQU8sS0FBMEIsRUFBRSxHQUFNO0lBQzdELE9BQU8sS0FBSyxZQUFZLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDeEQsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLElBQUksR0FBRyxHQUFHLEVB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WyIvLyB0c2xpbnQ6ZGlzYWJsZTogbm8tYml0d2lzZVxuXG5mdW5jdGlvbiBzYWZlTWF0Y2goYmFzZTogc3RyaW5nLCByZTogUmVnRXhwKSB7XG4gIHJldHVybiAoYmFzZS5tYXRjaChyZSkgfHwgW10pWzBdIHx8ICcnO1xufVxuZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVVcmwodXJsOiBzdHJpbmcsIGJhc2U6IHN0cmluZyk6IHN0cmluZyB7XG4gIGlmICh1cmwuaW5kZXhPZignaHR0cHM6Ly8nKSAqIHVybC5pbmRleE9mKCdodHRwOi8vJykgPT09IDApIHtcbiAgICByZXR1cm4gdXJsO1xuICB9XG4gIGlmICh1cmwuaW5kZXhPZignLy8nKSA9PT0gMCkge1xuICAgIHJldHVybiBzYWZlTWF0Y2goYmFzZSwgL14oaHR0cHM/OikvKSArIHVybDtcbiAgfVxuICBpZiAodXJsLmluZGV4T2YoJy8nKSA9PT0gMCkge1xuICAgIHJldHVybiBzYWZlTWF0Y2goYmFzZSwgL14oPzpodHRwcz86KT8oPzpcXC9cXC8pPyhbXlxcL1xcP10rKS8pICsgdXJsO1xuICB9XG4gIHJldHVybiBzYWZlTWF0Y2goYmFzZSwgL14oPzpodHRwcz86KT8oPzpcXC9cXC8pPyhbXlxcL1xcP10rKT8oLipcXC8pLykgKyB1cmw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1bmZ1bmM8VCwgVj4odmFsdWU6IFQgfCAoKHJlZjogVikgPT4gVCksIHJlZjogVik6IFQge1xuICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBGdW5jdGlvbiA/IHZhbHVlKHJlZikgOiB2YWx1ZTtcbn1cblxuZXhwb3J0IGNvbnN0IG5vb3AgPSAoKSA9PiB7fTtcblxuZXhwb3J0IGNvbnN0IHBpY2sgPSA8VCwgSyBleHRlbmRzIGtleW9mIFQ+KG9iajogVCwgd2hpdGVsaXN0OiBLW10pOiBQaWNrPFQsIEs+ID0+IHtcbiAgY29uc3QgcmVzdWx0OiBhbnkgPSB7fTtcbiAgd2hpdGVsaXN0LmZvckVhY2goa2V5ID0+IChyZXN1bHRba2V5XSA9IG9ialtrZXldKSk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gaXNOdW1iZXIoeDogdW5rbm93bik6IHggaXMgbnVtYmVyIHtcbiAgcmV0dXJuIHggPT09IE51bWJlcih4KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzU3RyaW5nKHg6IHVua25vd24pOiB4IGlzIHN0cmluZyB7XG4gIHJldHVybiB0eXBlb2YgeCA9PT0gJ3N0cmluZyc7XG59XG5cbi8qKlxuICogMzItYml0IEZOVi0xYSBoYXNoIGZ1bmN0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVIYXNoKHN0cjogc3RyaW5nKTogbnVtYmVyIHtcbiAgbGV0IGhhc2ggPSAyMTY2MTM2MjYxO1xuICBjb25zdCBsZW4gPSBzdHIubGVuZ3RoO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgaGFzaCBePSBzdHIuY2hhckNvZGVBdChpKTtcbiAgICBoYXNoICs9IChoYXNoIDw8IDEpICsgKGhhc2ggPDwgNCkgKyAoaGFzaCA8PCA3KSArIChoYXNoIDw8IDgpICsgKGhhc2ggPDwgMjQpO1xuICB9XG4gIHJldHVybiBoYXNoID4+PiAwO1xufVxuZXhwb3J0IGNvbnN0IGI2NCA9IHtcbiAgZW5jb2RlOiAoc3RyOiBzdHJpbmcpID0+XG4gICAgYnRvYShcbiAgICAgIGVuY29kZVVSSUNvbXBvbmVudChzdHIpLnJlcGxhY2UoLyUoWzAtOUEtRl17Mn0pL2csIChtYXRjaCwgcDEpID0+XG4gICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoTnVtYmVyLnBhcnNlSW50KHAxLCAxNikpXG4gICAgICApXG4gICAgKSxcbiAgZGVjb2RlOiAoc3RyOiBzdHJpbmcpID0+XG4gICAgZGVjb2RlVVJJQ29tcG9uZW50KFxuICAgICAgYXRvYihzdHIpXG4gICAgICAgIC5zcGxpdCgnJylcbiAgICAgICAgLm1hcChjID0+ICclJyArICgnMDAnICsgYy5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTIpKVxuICAgICAgICAuam9pbignJylcbiAgICApLFxuICBzZXJpYWxpemU6IChvYmo6IFJlY29yZDxzdHJpbmcsIGFueT4pID0+IHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMob2JqKVxuICAgICAgLm1hcCgoW2tleSwgdmFsdWVdKSA9PiBgJHtrZXl9ICR7YjY0LmVuY29kZShTdHJpbmcodmFsdWUpKX1gKVxuICAgICAgLnRvU3RyaW5nKCk7XG4gIH0sXG4gIHBhcnNlOiAoZW5jb2RlZDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3Qga3ZQYWlycyA9IGVuY29kZWQuc3BsaXQoJywnKS5tYXAoa3YgPT4ga3Yuc3BsaXQoJyAnKSk7XG4gICAgY29uc3QgZGVjb2RlZCA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2Yga3ZQYWlycykge1xuICAgICAgZGVjb2RlZFtrZXldID0gYjY0LmRlY29kZSh2YWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiBkZWNvZGVkO1xuICB9XG59O1xuXG4vKipcbiAqIEFkYXB0aXZlIGNodW5rIHNpemVcbiAqL1xuZXhwb3J0IGNsYXNzIER5bmFtaWNDaHVuayB7XG4gIC8qKiBNYXhpbXVtIGNodW5rIHNpemUgaW4gYnl0ZXMgKi9cbiAgc3RhdGljIG1heFNpemUgPSBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUjtcbiAgLyoqIE1pbmltdW0gY2h1bmsgc2l6ZSBpbiBieXRlcyAqL1xuICBzdGF0aWMgbWluU2l6ZSA9IDEwMjQgKiAyNTY7XG4gIC8qKiBJbml0aWFsIGNodW5rIHNpemUgaW4gYnl0ZXMgKi9cbiAgc3RhdGljIHNpemUgPSA0MDk2ICogMjU2O1xuICBzdGF0aWMgbWluQ2h1bmtUaW1lID0gMjtcbiAgc3RhdGljIG1heENodW5rVGltZSA9IDg7XG5cbiAgc3RhdGljIHNjYWxlKHRocm91Z2hwdXQ6IG51bWJlcikge1xuICAgIGNvbnN0IGVsYXBzZWRUaW1lID0gRHluYW1pY0NodW5rLnNpemUgLyB0aHJvdWdocHV0O1xuICAgIGlmIChlbGFwc2VkVGltZSA8IER5bmFtaWNDaHVuay5taW5DaHVua1RpbWUpIHtcbiAgICAgIER5bmFtaWNDaHVuay5zaXplID0gTWF0aC5taW4oRHluYW1pY0NodW5rLm1heFNpemUsIER5bmFtaWNDaHVuay5zaXplICogMik7XG4gICAgfVxuICAgIGlmIChlbGFwc2VkVGltZSA+IER5bmFtaWNDaHVuay5tYXhDaHVua1RpbWUpIHtcbiAgICAgIER5bmFtaWNDaHVuay5zaXplID0gTWF0aC5tYXgoRHluYW1pY0NodW5rLm1pblNpemUsIER5bmFtaWNDaHVuay5zaXplIC8gMik7XG4gICAgfVxuICAgIHJldHVybiBEeW5hbWljQ2h1bmsuc2l6ZTtcbiAgfVxufVxuIl19