!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("ngx-uploadx",["exports","@angular/core","rxjs","rxjs/operators"],e):e((t=t||self)["ngx-uploadx"]={},t.ng.core,t.rxjs,t.rxjs.operators)}(this,(function(t,e,n,r){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function s(t,e){function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var i,a=function(){return(a=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function u(t,e,n,r){var o,s=arguments.length,i=s<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(i=(s<3?o(i):s>3?o(e,n,i):o(e,n))||i);return s>3&&i&&Object.defineProperty(e,n,i),i}function c(t,e,n,r){return new(n||(n=Promise))((function(o,s){function i(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(i,a)}u((r=r.apply(t,e||[])).next())}))}function p(t,e){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}function l(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function h(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,s=n.call(t),i=[];try{for(;(void 0===e||e-- >0)&&!(r=s.next()).done;)i.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(o)throw o.error}}return i}(i=t.ErrorType||(t.ErrorType={}))[i.Restart=0]="Restart",i[i.Auth=1]="Auth",i[i.Retryable=2]="Retryable",i[i.FatalError=3]="FatalError";var f=function(){function e(){this.min=500,this.max=120*this.min,this.factor=2,this.attempts=1,this.code=-1,this.delay=this.min}return e.prototype.kind=function(n){if(n===this.code){if(this.attempts++,this.attempts>e.maxAttempts)return t.ErrorType.FatalError}else this.reset();return this.code=n,e.authErrorCodes.includes(n)?t.ErrorType.Auth:e.shouldRestartCodes.includes(n)?t.ErrorType.Restart:n<400||n>=500||e.shouldRetryCodes.includes(n)?t.ErrorType.Retryable:t.ErrorType.FatalError},e.prototype.wait=function(){var t=this;return new Promise((function(e){t.delay=Math.min(t.delay*t.factor,t.max),setTimeout((function(){return e(t.attempts)}),t.delay+Math.floor(Math.random()*t.min))}))},e.prototype.reset=function(){this.delay=this.min,this.attempts=1,this.code=-1},e.maxAttempts=8,e.shouldRestartCodes=[404,410],e.authErrorCodes=[401],e.shouldRetryCodes=[423,429],e}(),d=function(){function t(t){void 0===t&&(t="UPLOADX-V3.0-"),this.prefix=t}return t.prototype.set=function(t,e){localStorage.setItem(this.prefix+t,e)},t.prototype.get=function(t){return localStorage.getItem(this.prefix+t)},t.prototype.delete=function(t){localStorage.removeItem(this.prefix+t)},t}(),y="localStorage"in window?new d:new Map;function v(t,e){return(t.match(e)||[])[0]||""}function m(t,e){return t.indexOf("https://")*t.indexOf("http://")==0?t:0===t.indexOf("//")?v(e,/^(https?:)/)+t:0===t.indexOf("/")?v(e,/^(?:https?:)?(?:\/\/)?([^\/\?]+)/)+t:v(e,/^(?:https?:)?(?:\/\/)?([^\/\?]+)?(.*\/)/)+t}function g(t,e){return t instanceof Function?t(e):t}var b=function(){},x=function(t,e){var n={};return e.forEach((function(e){return n[e]=t[e]})),n};function S(t){return t===Number(t)}function w(t){for(var e=2166136261,n=t.length,r=0;r<n;r++)e^=t.charCodeAt(r),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return e>>>0}var T={encode:function(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(function(t,e){return String.fromCharCode(Number.parseInt(e,16))})))},decode:function(t){return decodeURIComponent(atob(t).split("").map((function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)})).join(""))},serialize:function(t){return Object.entries(t).map((function(t){var e=h(t,2),n=e[0],r=e[1];return n+" "+T.encode(String(r))})).toString()},parse:function(t){var e,n,r=t.split(",").map((function(t){return t.split(" ")})),o=Object.create(null);try{for(var s=l(r),i=s.next();!i.done;i=s.next()){var a=h(i.value,2),u=a[0],c=a[1];o[u]=T.decode(c)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}return o}},E=function(){function t(){}return t.scale=function(e){var n=t.size/e;return n<t.minChunkTime&&(t.size=Math.min(t.maxSize,2*t.size)),n>t.maxChunkTime&&(t.size=Math.max(t.minSize,t.size/2)),t.size},t.maxSize=Number.MAX_SAFE_INTEGER,t.minSize=262144,t.size=1048576,t.minChunkTime=2,t.maxChunkTime=8,t}(),O={pause:"paused",upload:"queue",cancel:"cancelled",uploadAll:"queue",pauseAll:"paused",cancelAll:"cancelled"},C=function(){function e(t,e){var n=this;this.file=t,this.options=e,this.headers={},this.endpoint="/upload",this.errorHandler=new f,this.offset=0,this.responseType="",this._url="",this.cleanup=function(){return y.delete(n.uploadId)},this.name=t.name,this.size=t.size,this.metadata={name:t.name,mimeType:t.type||"application/octet-stream",size:t.size,lastModified:t.lastModified};var r=JSON.stringify(a({},this.metadata,{type:this.constructor.name,endpoint:e.endpoint}));this.uploadId=w(r).toString(16),this.stateChange=e.stateChange||b,this.chunkSize=e.chunkSize||this.size,this.configure(e)}return Object.defineProperty(e.prototype,"status",{get:function(){return this._status},set:function(t){"cancelled"===this._status||"complete"===this._status&&"cancelled"!==t||t!==this._status&&("paused"===t&&this.abort(),this._status=t,["cancelled","complete","error"].includes(t)&&this.cleanup(),"cancelled"===t?this.onCancel():this.stateChange(this))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._url||y.get(this.uploadId)||""},set:function(t){this._url!==t&&y.set(this.uploadId,t),this._url=t},enumerable:!0,configurable:!0}),e.prototype.configure=function(t){var e=t.metadata,n=void 0===e?{}:e,r=t.headers,o=void 0===r?{}:r,s=t.token,i=t.endpoint,u=t.action;this.endpoint=i||this.endpoint,this.token=s||this.token,this.metadata=a({},this.metadata,g(n,this.file)),this.headers=a({},this.headers,g(o,this.file)),u&&(this.status=O[u])},e.prototype.upload=function(){return c(this,void 0,void 0,(function(){var e,n;return p(this,(function(r){switch(r.label){case 0:this.status="uploading",r.label=1;case 1:return r.trys.push([1,5,,9]),[4,this.getToken()];case 2:return r.sent(),this.offset=void 0,this.startTime=(new Date).getTime(),e=this,(n=this.url)?[3,4]:[4,this.getFileUrl()];case 3:n=r.sent(),r.label=4;case 4:return e.url=n,this.errorHandler.reset(),this.start(),[3,9];case 5:return r.sent(),this.errorHandler.kind(this.responseStatus)===t.ErrorType.FatalError?[3,7]:(this.status="retry",[4,this.errorHandler.wait()]);case 6:return r.sent(),this.status="queue",[3,8];case 7:this.status="error",r.label=8;case 8:return[3,9];case 9:return[2]}}))}))},e.prototype.start=function(){return c(this,void 0,void 0,(function(){var e,n,r;return p(this,(function(o){switch(o.label){case 0:if("uploading"!==this.status&&"retry"!==this.status)return[3,17];if(this.offset===this.size)return[3,15];o.label=1;case 1:return o.trys.push([1,6,,14]),S(this.offset)?[4,this.sendFileContent()]:[3,3];case 2:return n=o.sent(),[3,5];case 3:return[4,this.getOffset()];case 4:n=o.sent(),o.label=5;case 5:if((e=n)===this.offset)throw new Error("Content upload failed");return this.errorHandler.reset(),this.offset=e,[3,14];case 6:return o.sent(),r=this.errorHandler.kind(this.responseStatus),413!==this.responseStatus?[3,7]:(E.maxSize=this.chunkSize/=2,[3,13]);case 7:return r!==t.ErrorType.FatalError?[3,8]:(this.status="error",[3,13]);case 8:return r!==t.ErrorType.Restart?[3,9]:(this.url="",this.status="queue",[3,13]);case 9:return r!==t.ErrorType.Auth?[3,11]:[4,this.getToken()];case 10:return o.sent(),[3,13];case 11:return this.status="retry",[4,this.errorHandler.wait()];case 12:o.sent(),this.offset=this.responseStatus>=400?void 0:this.offset,this.status="uploading",o.label=13;case 13:return[3,14];case 14:return[3,16];case 15:this.progress=100,this.remaining=0,this.status="complete",o.label=16;case 16:return[3,0];case 17:return[2]}}))}))},e.prototype.request=function(t){var e=this,n=t.method,r=void 0===n?"GET":n,o=t.body,s=void 0===o?null:o,i=t.url,u=t.headers,c=void 0===u?{}:u,p=t.progress;return new Promise((function(t,n){var o=e._xhr=new XMLHttpRequest;o.open(r,i||e.url,!0),(s instanceof Blob||s&&p)&&(o.upload.onprogress=e.onProgress()),e.responseStatus=0,e.response=void 0,e.responseType&&(o.responseType=e.responseType),e.options.withCredentials&&(o.withCredentials=!0);var u=a({},e.headers,c);Object.keys(u).forEach((function(t){return o.setRequestHeader(t,u[t])})),o.onload=function(r){e.responseStatus=o.status,e.response=204!==e.responseStatus?e.getResponseBody(o):"",e.responseStatus>=400?n(r):t(r)},o.onerror=n,o.send(s)}))},e.prototype.setAuth=function(t){this.headers.Authorization="Bearer "+t},e.prototype.abort=function(){this.offset=void 0,this._xhr&&this._xhr.abort()},e.prototype.onCancel=function(){var t=this;this.abort();var e=function(){return t.stateChange(t)};this.url?this.request({method:"DELETE"}).then(e,e):e()},e.prototype.getValueFromResponse=function(t){return this._xhr.getResponseHeader(t)},e.prototype.getToken=function(){var t=this;return Promise.resolve(g(this.token||"",this.responseStatus)).then((function(e){return e&&t.setAuth(e)}))},e.prototype.getChunk=function(){this.chunkSize=S(this.options.chunkSize)?this.chunkSize:E.size;var t=this.offset||0,e=Math.min(t+this.chunkSize,this.size);return{start:t,end:e,body:this.file.slice(this.offset,e)}},e.prototype.getResponseBody=function(t){var e="response"in t?t.response:t.responseText;if(e&&"json"===this.responseType&&"string"==typeof e)try{e=JSON.parse(e)}catch(t){}return e},e.prototype.onProgress=function(){var t=this,e=0;return function(n){var r=n.loaded,o=(new Date).getTime(),s=t.offset+r,i=(o-t.startTime)/1e3;t.speed=Math.round(s/i),E.scale(t.speed),e||(e=window.setTimeout((function(){return e=0}),500),t.progress=+(s/t.size*100).toFixed(2),t.remaining=Math.ceil((t.size-s)/t.speed),t.stateChange(t))}},e}(),R=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.headers={"Tus-Resumable":"1.0.0"},e}return s(e,t),e.prototype.getFileUrl=function(){return c(this,void 0,void 0,(function(){var t,e,n;return p(this,(function(r){switch(r.label){case 0:return t=T.serialize(this.metadata),e={"Upload-Length":""+this.size,"Upload-Metadata":""+t},[4,this.request({method:"POST",url:this.endpoint,headers:e})];case 1:if(r.sent(),!(n=this.getValueFromResponse("location")))throw new Error("Invalid or missing Location header");return this.offset=201===this.responseStatus?0:void 0,[2,m(n,this.endpoint)]}}))}))},e.prototype.sendFileContent=function(){return c(this,void 0,void 0,(function(){var t,e;return p(this,(function(n){switch(n.label){case 0:return t=this.getChunk().body,e={"Content-Type":"application/offset+octet-stream","Upload-Offset":""+this.offset},[4,this.request({method:"PATCH",body:t,headers:e})];case 1:return n.sent(),[2,this.getOffsetFromResponse()]}}))}))},e.prototype.getOffset=function(){return c(this,void 0,void 0,(function(){return p(this,(function(t){switch(t.label){case 0:return[4,this.request({method:"HEAD"})];case 1:return t.sent(),[2,this.getOffsetFromResponse()]}}))}))},e.prototype.getOffsetFromResponse=function(){var t=this.getValueFromResponse("Upload-Offset");return t?parseInt(t,10):void 0},e}(C),z=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.responseType="json",e}return s(e,t),e.prototype.getFileUrl=function(){return c(this,void 0,void 0,(function(){var t,e;return p(this,(function(n){switch(n.label){case 0:return t={"Content-Type":"application/json; charset=utf-8","X-Upload-Content-Length":this.size.toString(),"X-Upload-Content-Type":this.file.type||"application/octet-stream"},[4,this.request({method:"POST",body:JSON.stringify(this.metadata),url:this.endpoint,headers:t})];case 1:if(n.sent(),!(e=this.getValueFromResponse("location")))throw new Error("Invalid or missing Location header");return this.offset=201===this.responseStatus?0:void 0,[2,m(e,this.endpoint)]}}))}))},e.prototype.sendFileContent=function(){return c(this,void 0,void 0,(function(){var t,e,n,r;return p(this,(function(o){switch(o.label){case 0:return t=this.getChunk(),e=t.end,n=t.body,r={"Content-Type":"application/octet-stream","Content-Range":"bytes "+this.offset+"-"+(e-1)+"/"+this.size},[4,this.request({method:"PUT",body:n,headers:r})];case 1:return o.sent(),[2,this.getOffsetFromResponse()]}}))}))},e.prototype.getOffset=function(){return c(this,void 0,void 0,(function(){var t;return p(this,(function(e){switch(e.label){case 0:return t={"Content-Type":"application/octet-stream","Content-Range":"bytes */"+this.size},[4,this.request({method:"PUT",headers:t})];case 1:return e.sent(),[2,this.getOffsetFromResponse()]}}))}))},e.prototype.getOffsetFromResponse=function(){if(this.responseStatus>201){var t=this.getValueFromResponse("Range");return t?F(t)+1:void 0}if(this.responseStatus<=201)return this.size},e}(C);function F(t){void 0===t&&(t="");var e=+t.split(/0-/)[1];return e>=0?e:-1}var j=function(){function t(t){var e=this;this.ngZone=t,this.queue=[],this.options={endpoint:"/upload",autoUpload:!0,concurrency:2,stateChange:function(t){setTimeout((function(){return e.ngZone.run((function(){return e.eventsStream.next(x(t,o.stateKeys))}))}))}},this.eventsStream=new n.Subject,this.subs=[],this.subs.push(n.fromEvent(window,"online").subscribe((function(){return e.control({action:"upload"})})),n.fromEvent(window,"offline").subscribe((function(){return e.control({action:"pause"})})),this.events.subscribe((function(t){var n=t.status;"uploading"!==n&&"added"!==n&&e.ngZone.runOutsideAngular((function(){return e.processQueue()}))})))}var o;return o=t,Object.defineProperty(t.prototype,"events",{get:function(){return this.eventsStream.asObservable()},enumerable:!0,configurable:!0}),t.prototype.init=function(t){return void 0===t&&(t={}),Object.assign(this.options,t),this.events},t.prototype.connect=function(t){var e=this;return this.init(t).pipe(r.startWith(0),r.map((function(){return e.queue})))},t.prototype.disconnect=function(){this.queue.forEach((function(t){return t.status="paused"})),this.queue=[]},t.prototype.ngOnDestroy=function(){this.disconnect(),this.subs.forEach((function(t){return t.unsubscribe()}))},t.prototype.handleFileList=function(t,e){var n=this;void 0===e&&(e={});var r=a({},this.options,e);this.options.concurrency=r.concurrency,Array.from(t).forEach((function(t){return n.addUploaderInstance(t,r)})),this.autoUploadFiles()},t.prototype.handleFile=function(t,e){void 0===e&&(e={});var n=a({},this.options,e);this.addUploaderInstance(t,n),this.autoUploadFiles()},t.prototype.control=function(t){(t.uploadId?this.queue.filter((function(e){return e.uploadId===t.uploadId})):this.queue).forEach((function(e){return e.configure(t)}))},t.prototype.runningProcess=function(){return this.queue.filter((function(t){var e=t.status;return"uploading"===e||"retry"===e})).length},t.prototype.addUploaderInstance=function(t,e){var n=new(e.uploaderClass||z)(t,e);this.queue.push(n),n.status="added"},t.prototype.autoUploadFiles=function(){this.options.autoUpload&&window.navigator.onLine&&this.queue.filter((function(t){return"added"===t.status})).forEach((function(t){return t.status="queue"}))},t.prototype.processQueue=function(){this.queue=this.queue.filter((function(t){return"cancelled"!==t.status})),this.queue.filter((function(t){return"queue"===t.status})).slice(0,Math.max(this.options.concurrency-this.runningProcess(),0)).forEach((function(t){return t.upload()}))},t.stateKeys=["file","name","progress","remaining","response","responseStatus","size","speed","status","uploadId","url"],t.ctorParameters=function(){return[{type:e.NgZone}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(e.NgZone))},token:t,providedIn:"root"}),t=o=u([e.Injectable({providedIn:"root"})],t)}(),k=function(){function t(t,n,r){this.elementRef=t,this.renderer=n,this.uploadService=r,this.uploadxState=new e.EventEmitter}return Object.defineProperty(t.prototype,"uploadxAction",{set:function(t){t&&this.uploadService&&this.uploadService.control(t)},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){var t=this.uploadx,e=t.multiple,n=t.allowedTypes;!1!==e&&this.renderer.setAttribute(this.elementRef.nativeElement,"multiple",""),n&&this.renderer.setAttribute(this.elementRef.nativeElement,"accept",n),this.uploadxState.emit(this.uploadService.events)},t.prototype.fileListener=function(t){t&&t.item(0)&&this.uploadService.handleFileList(t,this.uploadx)},t.ctorParameters=function(){return[{type:e.ElementRef},{type:e.Renderer2},{type:j}]},u([e.Output()],t.prototype,"uploadxState",void 0),u([e.Input()],t.prototype,"uploadx",void 0),u([e.Input()],t.prototype,"uploadxAction",null),u([e.HostListener("change",["$event.target.files"])],t.prototype,"fileListener",null),t=u([e.Directive({selector:"[uploadx]"})],t)}(),q=function(){function t(t){this.uploadService=t,this.active=!1}return t.prototype.dropHandler=function(t){t.dataTransfer&&t.dataTransfer.files&&(t.stopPropagation(),t.preventDefault(),this.active=!1,t.dataTransfer.files.item(0)&&this.uploadService.handleFileList(t.dataTransfer.files,this.fileInput.uploadx))},t.prototype.onDragOver=function(t){t.dataTransfer&&t.dataTransfer.files&&(t.dataTransfer.dropEffect="copy",t.stopPropagation(),t.preventDefault(),this.active=!0)},t.prototype.onDragLeave=function(t){this.active=!1},t.ctorParameters=function(){return[{type:j}]},u([e.HostBinding("class.uploadx-drop-active")],t.prototype,"active",void 0),u([e.ContentChild(k)],t.prototype,"fileInput",void 0),u([e.HostListener("drop",["$event"])],t.prototype,"dropHandler",null),u([e.HostListener("dragover",["$event"])],t.prototype,"onDragOver",null),u([e.HostListener("dragleave",["$event"])],t.prototype,"onDragLeave",null),t=u([e.Directive({selector:"[uploadxDrop]"})],t)}(),I=function(){function t(){}return t=u([e.NgModule({declarations:[k,q],exports:[k,q]})],t)}();t.DynamicChunk=E,t.ErrorHandler=f,t.Tus=R,t.Uploader=C,t.UploaderX=z,t.UploadxDirective=k,t.UploadxDropDirective=q,t.UploadxModule=I,t.UploadxService=j,t.b64=T,t.createHash=w,t.getRangeEnd=F,t.isNumber=S,t.isString=function(t){return"string"==typeof t},t.noop=b,t.pick=x,t.resolveUrl=m,t.unfunc=g,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ngx-uploadx.umd.min.js.map